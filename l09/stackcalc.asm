.ORIG x3000

LEA R6, STACK_BOT

JSR POP
AND R0, R0, #0
ADD R0, R0, #3
JSR PUSH
ADD R0, R0, #1
JSR PUSH
JSR STACKADD
HALT

STACKADD
; R3: first operand
; R0: second operand, sum
ST R3, STACK_CALC_R3_SAVE
ST R7, STACK_CALC_R7_SAVE

JSR POP
ADD R5, R5, #0
BRp STACKADDFAIL
ADD R3, R0, #0

JSR POP
ADD R5, R5, #0
BRp REPUSH

ADD R0, R0, R3
JSR PUSH
BRnzp STACKADDFAIL

REPUSH
ADD R0, R3, #0
JSR PUSH
;; fall through
STACKADDFAIL
LD R3, STACK_CALC_R3_SAVE
LD R7, STACK_CALC_R7_SAVE

RET

STACK_CALC_R3_SAVE .FILL #0
STACK_CALC_R7_SAVE .FILL #0

; PUSH
; input: R0 (value)
; output: R5 (0 success 1 failure)
PUSH
; R3: stack-end
; R6: stack-top

ST R3, STACK_R3_SAVE
LEA R3, STACK_TOP
NOT R3, R3
ADD R3, R3, #1
ADD R3, R6, R3
BRnz PUSH_NO_SPACE
ADD R6, R6, #-1
STR R0, R6, #0
AND R5, R5, #0
PUSH_RESTORE_RET
LD R3, STACK_R3_SAVE
RET
PUSH_NO_SPACE
AND R5, R5, #0
ADD R5, R5, #1
BRnzp PUSH_RESTORE_RET

; POP
; output: R0
; output: R5 (0 success 1 failure)
; R3: stack-start
; R6: stack-current
POP
ST R3, STACK_R3_SAVE
LEA R3, STACK_BOT
NOT R3, R3
ADD R3, R3, #1
ADD R3, R6, R3
BRzp POP_EMPTY
LDR R0, R6, #0
ADD R6, R6, #1
AND R5, R5, #0
POP_RESTORE_RET
LD R3, STACK_R3_SAVE
RET
POP_EMPTY
AND R5, R5, #0
ADD R5, R5, #1
BRnzp POP_RESTORE_RET

STACK_R3_SAVE .FILL #0

STACK_TOP .FILL x0000
.BLKW x20
STACK_BOT .FILL x0000
	
.END
